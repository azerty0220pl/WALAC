/*
  aquarium_v3.1.2
  By: Szymon Kokot
  Last modification: 23/03/21

  Requirements:
   - Arduino Mega2560
   - ESP8266
   - RTC ds1307
   - LCD display 16x2
   - Optocoupler
   - Triac
   - Wires, resistors, etc.

  Pinout:
   - 21 > RTC SLC
   - 20 > RTC SDA
   - 17 > ESP8266 TX
   - 16 > ESP8266 RX (level shifter required)
   - 13 > Built-in LED working "as Watch Dog"
   - 12 > LCD RS
   - 11 > LCD Enable
   - 9  > OptoCoupler
   - 8  > Main Switch
   - 7  > Button (manual turn on/off)
   - 5  > LCD D4
   - 4  > LCD D5
   - 3  > LCD D6
   - 2  > LCD D7

  Smartphone app: https://play.google.com/store/apps/details?id=com.Azerty0220pl.Aquarium
*/

#include <LiquidCrystal.h>
#include <Wire.h>
#include <RTClib.h>

//LCD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
byte rs = 12, e = 11, d4 = 5, d5 = 4, d6 = 3, d7 = 2;
LiquidCrystal lcd(rs, e, d4, d5, d6, d7);

//RTC///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
RTC_DS1307 rtc;
DateTime now;

char daysOfTheWeek[7][12] = {"Nie.", "Pon.", "Wto.", "Sro.", "Czw.", "Ptk.", "Sob."};

//Turn on/off times/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//On
byte hour1 = 8;
byte minute1 = 00;
//Off
byte hour3 = 8;
byte minute3 = 30;
//On
byte hour2 = 14;
byte minute2 = 30;
//Off
byte hour4 = 18;
byte minute4 = 30;

//WiFi Configuration////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
String ssid = "";
String pass = "";
int port = 5001;
String command = "";

//Other/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
byte light = 9;
byte lightMain = 8;
byte manualLight = 7;
byte manualAllLight = 6;
int lightStatus = 3;
bool change = true; // if false, light will not turn on/off
int resetTime = 10; // seconds that lights will be reseting before second light on
byte rep = 2;       // repetition for MIDDLE lights
byte blinkLed = 13; // built-in led will blink. If not blinking, something went wrong

//Setup/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void setup()
{
  //LCD Setup///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  lcd.begin(16, 2);
  lcd.clear();
  welcomeScreen();

  //RTC Setup///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  rtc.begin();
  rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));

  //Pin Setup///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  pinMode(light, OUTPUT);
  pinMode(lightMain, OUTPUT);
  pinMode(blinkLed, OUTPUT);
  pinMode(manualLight, INPUT);
  pinMode(manualAllLight, INPUT);

  //Serial Communication with computer and esp8266//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  Serial.begin(9600);
  Serial2.begin(115200);

  //Other///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  while (!espSetup(ssid, pass, port));
  digitalWrite(lightMain, HIGH);
}

//Loop//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void loop()
{
  //Watch Dog (blinkLed)////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  digitalWrite(blinkLed, now.second() % 2);

  //Lights control//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Automatic switch on/off
  if (change)
  {
    if ((TimeToFloat(now.hour(), now.minute()) >= TimeToFloat(hour1, minute1) &&
         TimeToFloat(now.hour(), now.minute()) <= TimeToFloat(hour3, minute3)) ||
        (TimeToFloat(now.hour(), now.minute()) >= TimeToFloat(hour2, minute2) &&
         TimeToFloat(now.hour(), now.minute()) <= TimeToFloat(hour4, minute4)))
      lightChange(1);
    else
      lightChange(0);
    /*if (now.hour() == hour1 && now.minute() == minute1) lightChange(1);
      if (now.hour() == hour3 && now.minute() == minute3) lightChange(0);
      if (now.hour() == hour2 && now.minute() == minute2) lightChange(1);
      if (now.hour() == hour4 && now.minute() == minute4) lightChange(0);
    */
  }

  //Manual switch on/off
  if (digitalRead(manualLight))
  {
    lightChange((lightStatus + 1) % 2);
    delay(750);
  }

  //Manual disable lights
  /*if (manualAllLight)
    lightChange(-1);*/

  //Other
  printTime();
  espCom();
}
